<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>個人別出席状況サマリー</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Meiryo',sans-serif;margin:20px;background:#f7f7fb;}
h1{font-size:20px;margin:0 0 12px;}
.card{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);padding:16px;margin-bottom:16px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.badge.ok{background:#e7f3ff;color:#1253c8}
.small{font-size:12px;color:#666}
.kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:8px;}
.kpi .item{background:#fafbff;border:1px solid #e7ebf3;border-radius:10px;padding:12px;text-align:center}
.kpi .num{font-size:20px;font-weight:700}
a.btn{display:inline-block;padding:10px 12px;background:#2f6feb;color:#fff;border-radius:8px;text-decoration:none}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}
</style>
<script>
function onStudentChange(sel){
  const opt = sel.selectedOptions[0];
  if(!opt) return;
  document.getElementById('student_no').value = opt.dataset.no || '';
  document.getElementById('gakka_id').value = opt.dataset.gakka || '';
}
</script>
</head>
<body>

<h1>個人別出席状況サマリー</h1>

<div class="card">
  <form method="get" action="{{ url_for('summary') }}">
    <div class="grid">
      <div>
        <label>学生を選択（学科 / 学生番号 / 生徒名）</label>
        <select onchange="onStudentChange(this)">
          <option value="">-- 選択してください --</option>
          {% for s in students %}
          <option value="{{s['学生番号']}}"
                  data-no="{{s['学生番号']}}"
                  data-name="{{s['生徒名']}}"
                  data-gakka="{{s['学科ID']}}"
                  {% if request.values.get('student_no') and s['学生番号']|string == request.values.get('student_no') %}selected{% endif %}>
            [{{s['学科名']}}] {{s['学生番号']}} : {{s['生徒名']}}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="grid">
        <div>
          <label>学科</label>
          <select id="gakka_id" name="gakka_id" required>
            {% for g in gakkas %}
              <option value="{{ g['学科ID'] }}"
                {% if request.values.get('gakka_id') and g['学科ID']|string == request.values.get('gakka_id') %}selected{% endif %}>
                {{ g['学科名'] }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>学生番号</label>
          <input id="student_no" name="student_no" value="{{ request.values.get('student_no','') }}" required>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:8px">
      <div>
        <label>開始日</label>
        <input type="date" name="start" value="{{ request.values.get('start', start_default) }}">
      </div>
      <div>
        <label>終了日</label>
        <input type="date" name="end" value="{{ request.values.get('end', end_default) }}">
      </div>
    </div>

    <div style="margin-top:10px"><button type="submit">サマリーを表示</button></div>
  </form>
  <div class="small" style="margin-top:6px">
    期間は「入室」行の出席状態を集計します（入室区分='入室'）。
  </div>
</div>

{% if totals %}
<div class="card">
  <h2 style="font-size:16px;margin:0 0 8px;">集計結果</h2>
  <div class="small" style="margin-bottom:6px;">
    対象: [{{ selected_gakka_name }}] {{ request.values.get('student_no') }} {{ selected_student_name or '' }}
    ／ 期間: {{ start_date }} 〜 {{ end_date }}
  </div>
  <div class="kpi">
    <div class="item"><div class="small">出席</div><div class="num">{{ totals['出席'] }}</div></div>
    <div class="item"><div class="small">遅刻</div><div class="num">{{ totals['遅刻'] }}</div></div>
    <div class="item"><div class="small">欠席</div><div class="num">{{ totals['欠席'] }}</div></div>
    <div class="item"><div class="small">合計（入室回数）</div><div class="num">{{ totals['合計'] }}</div></div>
  </div>

  <div class="btn-row" style="margin-top:10px">
    <a class="btn" href="{{ url_for('download_csv', student=request.values.get('student_no'), gakka=request.values.get('gakka_id'), start=start_date, end=end_date) }}">
      この条件でCSVダウンロード
    </a>
    <a class="btn" href="{{ url_for('index') }}">トップへ戻る</a>
  </div>
</div>

<div class="card">
  <h2 style="font-size:16px;margin:0 0 8px;">日別（最初の入室）</h2>
  <table class="table">
    <thead><tr><th>日付</th><th>最初の入室時刻</th><th>出席状態</th></tr></thead>
    <tbody>
      {% for r in daily %}
      <tr>
        <td>{{ r['日付'] }}</td>
        <td>{{ r['最初入室'] }}</td>
        <td>
          {% if r['出席状態']=='出席' %}
            <span class="badge ok">出席</span>
          {% else %}
            {{ r['出席状態'] }}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if daily|length == 0 %}
      <tr><td colspan="3" class="small">該当データがありません。</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2 style="font-size:16px;margin:0 0 8px;">詳細入退室ログ</h2>
  <table class="table">
    <thead>
      <tr>
        <th>入退出時間</th>
        <th>入室区分</th>
        <th>時限</th>          <!-- ← 追加 -->
        <th>出席状態</th>
        <th>入室時刻</th>
        <th>離席時間</th>
      </tr>
    </thead>
    <tbody>
      {% for r in attendance_details %}
      <tr>
        <td>{{ r['入退出時間'] }}</td>
        <td>{{ r['入室区分'] }}</td>
        <td>{{ r['時限'] if r['時限'] is not none else '' }}{% if r['時限'] is not none %}限{% endif %}</td>  <!-- ← 追加 -->
        <td>{{ r['出席状態'] }}</td>
        <td>{{ r['入室時刻'] or '' }}</td>
        <td>{{ r['離席時間'] }}</td>
      </tr>
      {% endfor %}
      {% if attendance_details|length == 0 %}
      <tr><td colspan="6" class="small">該当データがありません。</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% endif %}

{% if subject_rates %}
<div class="card">
  <h2 style="font-size:16px;margin:0 0 8px;">科目別 出席率</h2>
  <table class="table">
    <thead>
      <tr>
        <th>授業科目</th>
        <th>出席</th>
        <th>遅刻</th>
        <th>欠席</th>
        <th>出席率(%)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in subject_rates %}
      <tr>
        <td>{{ r["授業科目"] }}</td>
        <td>{{ r["出席"] }}</td>
        <td>{{ r["遅刻"] }}</td>
        <td>{{ r["欠席"] }}</td>
        <td>{{ r["出席率(%)"] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="small">※ 各日の「最初の入室」をその日の受講コマとして集計。出席率 = 出席 / (出席+遅刻+欠席)</div>
</div>
{% endif %}

<div class="small">DB: {{ db_path }}</div>
</body>
</html>